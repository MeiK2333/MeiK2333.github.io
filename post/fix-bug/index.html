<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://meik2333.com/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://meik2333.com/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/github.min.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/github-style.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/light.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/dark.css' />
    <title>我是如何找到一个 BUG 的 - MeiK&#39;s blog</title>
    <link rel="icon" type="image/x-icon" href='https://meik2333.com/images/favicon.ico'>
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="本文介绍了我是如何找到一个 BUG 的。
" />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://meik2333.com/post/fix-bug/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="我是如何找到一个 BUG 的 - MeiK&#39;s blog" />
<meta name="twitter:description"
  content="本文介绍了我是如何找到一个 BUG 的。
" />
<meta name="twitter:site" content="https://meik2333.com/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://meik2333.com/">


<meta property="og:type" content="article" />
<meta property="og:title" content="我是如何找到一个 BUG 的 - MeiK&#39;s blog">
<meta property="og:description"
  content="本文介绍了我是如何找到一个 BUG 的。
" />
<meta property="og:url" content="https://meik2333.com/post/fix-bug/" />
<meta property="og:site_name" content="我是如何找到一个 BUG 的" />
<meta property="og:image"
  content="https://meik2333.com/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-01-29 21:27:43 &#43;0000 UTC" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://meik2333.com/">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://meik2333.com/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://meik2333.com/">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://meik2333.com/">
                  <img class=" avatar-user"
                    src="https://meik2333.com/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://meik2333.com/">MeiK</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://meik2333.com/post/fix-bug/">我是如何找到一个 BUG 的</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Tue, 29 Jan 2019 21:27:43 &#43;0000"
                    class="no-wrap">
                    Tue, 29 Jan 2019 21:27:43 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Fri, 11 Oct 2019 17:33:00 &#43;0800"
                    class="no-wrap">
                    Fri, 11 Oct 2019 17:33:00 &#43;0800</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    2199 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/python">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Python
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/bug">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      BUG
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/%E7%88%AC%E8%99%AB">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      爬虫
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><p>本文介绍了我是如何找到一个 BUG 的。</p>

<p>首先要说一句，自我工作以来，我已经很久没有发布过新的技术博客了。并不是因为没有东西可以分享或者太忙，而是越来越发现自己才疏学浅，实在不敢将自己对某门技术浅薄的认知发布在网上。</p>

<p>不过有错误才有进步，之后还是要多写博客才是。</p>

<h2 id="开发环境">开发环境</h2>

<ul>
<li>Ubuntu 18.04</li>
<li>Python 3.6.7</li>
<li>VSCode</li>
</ul>

<h2 id="背景">背景</h2>

<p>这几天我写了一个爬虫项目 <a href="https://github.com/MeiK2333/SDUT_RESTful_API">SDUT_RESTful_API</a>，其特点为通过全异步的 WEB 端与爬虫后端来实现高并发。WEB 端使用了异步框架 <a href="https://github.com/huge-success/sanic">Sanic</a>，爬虫端则使用了异步网络请求库 <a href="aiohttp">aiohttp</a>。</p>

<h2 id="发现问题">发现问题</h2>

<p>因为有多个网站可以通过<a href="http://authserver.sdut.edu.cn/authserver/login">山东理工大学统一登录平台</a>登录，因此我首先尝试写一个模拟登录统一登录平台的爬虫：</p>

<pre><code class="language-python">import aiohttp

data = {
    'username': username,
    'password': password
}
async with aiohttp.ClientSession() as session:
    # 创建一个 ClientSession，然后提交登录接口，session 会自动处理 cookies
    await session.post('http://authserver.sdut.edu.cn/authserver/login', data=data)

    # 使用 session 进行一些查询
    await some_search(session)
</code></pre>

<p>如果通过了登录的话，那么后续的查询应该是可以使用的。但在实际使用中，却发现后续的查询无法使用。经过输出调试，发现没有登录成功。</p>

<h2 id="考虑反爬虫">考虑反爬虫</h2>

<p>最开始考虑是不是触发对方的反爬虫策略了，从 Chrome Network 中找到这条请求，<code>Copy as cUrl</code> 来模拟请求一下：</p>

<pre><code class="language-bash">curl 'http://authserver.sdut.edu.cn/authserver/login' -H 'Connection: keep-alive' -H 'Cache-Control: max-age=0' -H 'Origin: http://authserver.sdut.edu.cn' -H 'Upgrade-Insecure-Requests: 1' -H 'Content-Type: application/x-www-form-urlencoded' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8' -H 'Referer: http://authserver.sdut.edu.cn/authserver/login' -H 'Accept-Encoding: gzip, deflate' -H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8' -H 'Cookie: route=&lt;route&gt;; JSESSIONID_auth=&lt;JSESSIONID_auth&gt;' --data 'username=&lt;username&gt;&amp;password=&lt;password&gt;&amp;lt=&lt;lt&gt;&amp;dllt=userNamePasswordLogin&amp;execution=e1s1&amp;_eventId=submit&amp;rmShown=1' --compressed
</code></pre>

<p>最常见的反爬虫一般会验证 header 中的数据，比如 <code>User-Agent</code> 和 <code>Referer</code>，cUrl 可以发送一条和浏览器相同的请求，可以使用 cUrl 来试探出对方到底对哪些字段进行了验证。</p>

<p>依次删除 header 中的字段，直到已经只剩下要发送的数据了，却还是能够正常获得返回。</p>

<pre><code class="language-bash">curl 'http://authserver.sdut.edu.cn/authserver/login' --data 'username=&lt;username&gt;&amp;password=&lt;password&gt;&amp;lt=&lt;lt&gt;&amp;dllt=userNamePasswordLogin&amp;execution=e1s1&amp;_eventId=submit&amp;rmShown=1'
</code></pre>

<p>说明其实网站没有对 header 进行验证，所以爬虫无效并不是触发了反爬虫。</p>

<h2 id="考虑机器人验证">考虑机器人验证</h2>

<p>既然没有被反爬虫干掉，那么为什么没有成功登录呢？分析登录的过程，发现一个登录流程有四次 302 重定向：</p>

<p><img src="/images/fix-bug/1.png" alt="" /></p>

<p>中间会重定向到一个 <code>/authserver/services/j_spring_cas_security_check</code> 页面，从地址上来分析，这个页面应该做了一些安全验证，那么会不会是在这个页面被检测到爬虫，然后被拒绝了呢？</p>

<p>因为涉及到多次重定向，每次都模拟一遍很麻烦，因此我们去 aiohttp 源码中输出一下中间值，以确定到底是哪里出了问题。</p>

<p>使用编辑器的追踪功能，我找到了 aiohttp 处理 post 请求的地方（<a href="https://github.com/aio-libs/aiohttp/blob/master/aiohttp/client.py#L845">client.py</a>）：</p>

<pre><code class="language-python">def post(self, url: StrOrURL,
            *, data: Any=None, **kwargs: Any) -&gt; '_RequestContextManager':
    &quot;&quot;&quot;Perform HTTP POST request.&quot;&quot;&quot;
    return _RequestContextManager(
        self._request(hdrs.METH_POST, url,
                        data=data,
                        **kwargs))
</code></pre>

<p>再次追入 <code>self._request</code> 函数，最终定位到实际处理重定向的位置（<a href="https://github.com/aio-libs/aiohttp/blob/master/aiohttp/client.py#L501">client.py</a>），在此处输出一下调试用的信息，从而确定到底是哪次请求出错了。</p>

<p>因为登录状态是用 <code>Cookie</code> 保持的，<code>Cookie</code> 是 <code>Response</code> 中 <code>header</code> 的 <code>Set-Cookie</code> 设置的，因此需要输出的就有以下几项：</p>

<ul>
<li><code>Cookie</code></li>
<li><code>header</code></li>
<li><code>url</code>，用以确定是哪次请求</li>
</ul>

<p>修改后的代码是这样的：</p>

<pre><code class="language-python">self._cookie_jar.update_cookies(resp.cookies, resp.url)

print(f'url: {resp.url}')
print(f'header: {resp.header}')
print(f'cookie: {resp.cookie}')

# redirects
if resp.status in (
        301, 302, 303, 307, 308) and allow_redirects:
</code></pre>

<p>然后再次发起请求，观察输出结果：</p>

<pre><code class="language-bash">url: http://authserver.sdut.edu.cn/authserver/login
headers: &lt;CIMultiDictProxy('Server': 'openresty', 'Date': 'Tue, 29 Jan 2019 11:28:20 GMT', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Cache-Control': 'no-cache', 'Cache-Control': 'no-store', 'Pragma': 'no-cache', 'Location': 'http://authserver.sdut.edu.cn/authserver/index.do', 'Expires': 'Thu, 01 Jan 1970 00:00:00 GMT', 'Set-Cookie': 'CASTGC=TGT-15-6GMEwIOVCygEdEFdIqMesWfznAOnu4wVpUJcGYToswV0MBbbbc1548761299811-XU6e-cas;Path=/authserver/;HttpOnly;Max-Age=604800;Expires=Tue,5 Feb 2019 11:28:00 GMT;', 'Set-Cookie': 'CASPRIVACY=; expires=Thu, 01-Jan-1970 01:00:00 GMT; path=/authserver/', 'Set-Cookie': 'iPlanetDirectoryPro=hcJpTHcrd51GAWEbsCb6Ee; domain=.nju.edu.cn; path=/')&gt;
cookies: Set-Cookie: CASPRIVACY=; Domain=authserver.sdut.edu.cn; expires=Thu, 01-Jan-1970 01:00:00 GMT; Path=/authserver/
Set-Cookie: iPlanetDirectoryPro=hcJpTHcrd51GAWEbsCb6Ee; Domain=nju.edu.cn; Path=/
url: http://authserver.sdut.edu.cn/authserver/index.do
headers: &lt;CIMultiDictProxy('Server': 'openresty', 'Date': 'Tue, 29 Jan 2019 11:28:20 GMT', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Location': 'http://authserver.sdut.edu.cn/authserver/login?service=http%3A%2F%2Fauthserver.sdut.edu.cn%2Fauthserver%2Fservices%2Fj_spring_cas_security_check')&gt;
cookies:
url: http://authserver.sdut.edu.cn/authserver/login?service=http://authserver.sdut.edu.cn/authserver/services/j_spring_cas_security_check
headers: &lt;CIMultiDictProxy('Server': 'openresty', 'Date': 'Tue, 29 Jan 2019 11:28:20 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Vary': 'Accept-Encoding', 'Cache-Control': 'no-cache', 'Cache-Control': 'no-store', 'Pragma': 'no-cache', 'Expires': 'Thu, 01 Jan 1970 00:00:00 GMT', 'Content-Encoding': 'gzip')&gt;
cookies:
</code></pre>

<p>然后可以发现，第一个请求就有问题：有一个 <code>Set-Cookie</code> 没有被正确的响应。我们找出没有被响应的 <code>Set-Cookie</code>：</p>

<pre><code>Set-Cookie: CASTGC=TGT-15-6GMEwIOVCygEdEFdIqMesWfznAOnu4wVpUJcGYToswV0MBbbbc1548761299811-XU6e-cas;Path=/authserver/;HttpOnly;Max-Age=604800;Expires=Tue,5 Feb 2019 11:28:00 GMT;
</code></pre>

<h2 id="简化问题">简化问题</h2>

<p>我现在找到了出现问题的地方，我可以解决它，只要我把它手动添加到 <code>Cookie</code> 中就完事儿了，但我想知道为什么会出现这个 BUG。</p>

<p>因为我要爬取的网站有登录限制，过多的登录会导致账号暂时不可用。为了能够稳定的重现 BUG 并调试它，我用 Flask 写了一个短小的发送同样响应的 Web 站点：</p>

<pre><code class="language-python">from flask import Flask, make_response

app = Flask(__name__)

@app.route('/')
def index():
    resp = make_response('Hello World!')
    resp.headers['Set-Cookie'] = 'CASTGC=TGT-15-6GMEwIOVCygEdEFdIqMesWfznAOnu4wVpUJcGYToswV0MBbbbc1548761299811-XU6e-cas;Path=/authserver/;HttpOnly;Max-Age=604800;Expires=Tue,5 Feb 2019 11:28:00 GMT;'
    return resp

if __name__ == '__main__':
    app.run(debug=True)
</code></pre>

<p>然后创建了一段爬虫代码来调试：</p>

<pre><code class="language-python">async with aiohttp.ClientSession() as session:
    async with session.get('http://localhost:5000') as resp:
        print(resp.header)
</code></pre>

<p>我不断的删除 <code>Set-Cookie</code> 中的字符，从而测试到底是哪里导致了问题的出现。最终我得到了一个最小的问题复现：</p>

<pre><code class="language-python">resp.headers['Set-Cookie'] = 'Hello=World; Expires=Thu,31 Jan 2019 05:56:00 GMT;'
</code></pre>

<p>我尝试用 cUrl 和 Requests 来解析这段数据，都可以正常的获得响应，只有 aiohttp 不可以。这时候我发现这段字符串的格式有点问题：</p>

<p>这是 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Date">MDN</a> 中说明的 <code>Expires</code> 格式：<code>&lt;day-name&gt;, &lt;day&gt; &lt;month&gt; &lt;year&gt; &lt;hour&gt;:&lt;minute&gt;:&lt;second&gt; GMT</code>。</p>

<p>按照 MDN 的格式，<code>Thu,</code> 后面和 <code>31</code> 前面少了一个空格，我添加了这个空格后， aiohttp 果然能够正常的解析这段字符串了。</p>

<p>看起来问题到此结束了： aiohttp 没有对不规范的 <code>Expires</code> 做解析。但经我测试，JavaScript、PHP 都可以正常解析没有空格的数据，同为 Python 库的 Requests 也可以。或许兼容这种写法才是正常的？</p>

<h2 id="找到问题代码">找到问题代码</h2>

<p>是什么导致了同为 Python 语言的两个库行为不同的？我继续追踪代码，找到了 aiohttp 为 <code>session</code> 设置 <code>cookie</code> 的地方（<a href="https://github.com/aio-libs/aiohttp/blob/master/aiohttp/cookiejar.py#L113">cookiejar.py</a>）：</p>

<pre><code class="language-python">for name, cookie in cookies:
    if not isinstance(cookie, Morsel):
        tmp = SimpleCookie()
        tmp[name] = cookie  # type: ignore
        cookie = tmp[name]
</code></pre>

<p>设置 <code>cookie</code> 实际上是由这个 <code>SimpleCookie</code> 类来完成的，再想往里追的时候发现编辑器无法跳转了，仔细一看，这个类是 Python 内置的类。</p>

<p>于是乎我找到了 Python 在 GitHub 上的库，找到了实际运行的代码 <a href="https://github.com/python/cpython/blob/master/Lib/http/cookies.py#L597">cookies.py</a>。这个文件挺短的，代码量也不多，很容易就找到了实际出问题的代码：<a href="https://github.com/python/cpython/blob/master/Lib/http/cookies.py#L444">一段正则表达式</a>。</p>

<h2 id="向官方提交-bug">向官方提交 BUG</h2>

<p>我向 Python Bugs 社区提交了这个 BUG：<a href="https://bugs.python.org/issue37522">bpo-37522</a>。</p>

<h2 id="最终解决问题">最终解决问题</h2>

<p>转回我自己的问题，我最后是如何解决的呢？</p>

<p>就像我在<a href="#简化问题">简化问题</a>节第一句说的那样，我手动处理了这个 <code>Set-Cookie</code>（<a href="https://github.com/MeiK2333/SDUT_RESTful_API/blob/master/spider/ehall/auth_server.py#L43">auth_server.py</a>）：</p>

<pre><code class="language-python"># 第一次请求禁止重定向，自行处理
async with session.post('http://authserver.sdut.edu.cn/authserver/login', data=data, allow_redirects=False) as resp:
    headers = resp.headers
    next_url = headers.get('Location')

    for key in headers:
        # 手动处理有问题的 `Set-Cookie`
        if key.lower() == 'set-cookie' and headers[key].startswith('CASTGC'):
            castgc = headers[key].split(';')[0][7:]
            session.cookie_jar.update_cookies(
                {'CASTGC': castgc}, URL('http://authserver.sdut.edu.cn/authserver'))
            break

# 手动进行后续的跳转
async with session.get(next_url) as resp:
    url = str(resp.url)

# 登录成功，进行信息查询
await some_search(session)
</code></pre>

<p>当然，我在分析到<a href="#简化问题">简化问题</a>节的时候就已经可以解决这个问题了，但如果就这样解决了问题跑路的话，后面的乐趣岂不是全都失去了？</p>

<p>经过推断、分析、查找和测试后终于解决了一个问题，这是爬虫的乐趣，应该也是其他技术的乐趣吧。</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://meik2333.com/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://meik2333.com/js/github-style.js"></script>



</html>